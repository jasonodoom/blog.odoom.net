<header
  class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"
>
  <div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto">
    <a
      class="-translate-y-[1px] text-2xl font-medium"
      href="/post/"
      >{{ site.Title }}</a
    >
    <div
      class="btn-dark text-[0px] shrink-0 cursor-pointer"
      role="button"
      aria-label="Dark"
    >
      <div class="dark-mode-slider">
        <div class="slider-track"></div>
        <div class="slider-thumb"></div>
      </div>
    </div>
    <!-- Search Button -->
    <div class="search-btn" role="button" aria-label="Search" onclick="toggleSearch()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    </div>
  </div>


  {{- $bg_color := $.Scratch.Get "bg_color" -}}<!---->

  <script>
    // base
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    // dark theme
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '{{- $bg_color -}}'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'true' : 'false');
      document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
    };

    // init - default to light mode
    // Check URL parameter first (for cross-domain navigation)
    const urlParams = new URLSearchParams(window.location.search);
    const darkParam = urlParams.get('dark');

    if (darkParam === '1') {
      setDark(true);
    } else if (darkParam === '0') {
      setDark(false);
    } else if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : false);
    }

    // Clean up URL parameter
    if (darkParam && window.history.replaceState) {
      const url = new URL(window.location);
      url.searchParams.delete('dark');
      window.history.replaceState({}, '', url);
    }

    // manual switch
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });

    // Pass dark mode preference to cross-domain home link
    const homeLink = document.getElementById('homeLink');
    if (homeLink) {
      homeLink.addEventListener('click', (e) => {
        e.preventDefault();
        const darkMode = document.documentElement.classList.contains('dark');
        window.location.href = homeLink.href + '?dark=' + (darkMode ? '1' : '0');
      });
    }

    // Search Functionality (Pagefind)
    let isPagefindLoaded = false;
    let previouslyFocusedElement = null; // Store the element that had focus before opening search

    async function loadPagefind() {
        if (isPagefindLoaded) return;
        
        try {
            // Dynamically load Pagefind
            const pagefind = await import('/pagefind/pagefind.js');
            window.pagefind = pagefind;
            await pagefind.init();
            isPagefindLoaded = true;
        } catch (e) {
            console.error('Error loading search index:', e);
            document.querySelector('.search-results').innerHTML = 
                '<div class="search-no-results">Search is currently unavailable.</div>';
        }
    }

    async function toggleSearch() {
        const overlay = document.querySelector('.search-overlay');
        const input = document.querySelector('.search-input');
        const searchBtn = document.querySelector('.search-btn');
        
        if (overlay.classList.contains('open')) {
            // Close overlay
            overlay.classList.remove('open');
            document.body.style.overflow = '';
            input.value = ''; // Clear input on close
            document.removeEventListener('keydown', trapTabKey);
            if (previouslyFocusedElement) {
                previouslyFocusedElement.focus(); // Restore focus
                previouslyFocusedElement = null;
            }
        } else {
            // Open overlay
            previouslyFocusedElement = document.activeElement; // Store currently focused element
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            input.focus();
            document.addEventListener('keydown', trapTabKey);
            await loadPagefind();
        }
    }

    function trapTabKey(e) {
        if (e.key === 'Tab') {
            const overlay = document.querySelector('.search-overlay');
            const focusableElements = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            if (e.shiftKey) { // Shift + Tab
                if (document.activeElement === firstFocusable) {
                    lastFocusable.focus();
                    e.preventDefault();
                }
            } else { // Tab
                if (document.activeElement === lastFocusable) {
                    firstFocusable.focus();
                    e.preventDefault();
                }
            }
        }
    }

    async function handleSearch(e) {
        const query = e.target.value;
        const resultsContainer = document.querySelector('.search-results');
        
        if (!query) {
            resultsContainer.innerHTML = '';
            return;
        }

        if (!window.pagefind) return;

        const search = await window.pagefind.search(query);
        const results = await Promise.all(search.results.slice(0, 10).map(r => r.data()));

        if (results.length > 0) {
            resultsContainer.innerHTML = results.map(item => `
                <a href="${item.url}" class="search-result-item" onclick="toggleSearch()">
                    <span class="search-result-title">${item.meta.title}</span>
                    <span class="search-result-date">${item.excerpt}</span>
                </a>
            `).join('');
        } else {
            resultsContainer.innerHTML = '<div class="search-no-results">No matches found</div>';
        }
    }
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const overlay = document.querySelector('.search-overlay');
            if (overlay.classList.contains('open')) {
                toggleSearch();
            }
        }
    });
  </script>

  <!-- Search Overlay -->
  <div class="search-overlay">
    <div class="search-close" onclick="toggleSearch()">×</div>
    <div class="search-input-wrapper">
        <input type="text" class="search-input" placeholder="Search musings..." oninput="handleSearch(event)">
    </div>
    <div class="search-results"></div>
  </div>

  <div
    class="nav-wrapper lg:static lg:h-auto lg:flex lg:flex-row lg:bg-transparent! lg:pb-0"
  >
    {{- $url := .RelPermalink -}}<!---->
    <nav
      class="ml-12 flex flex-row items-center space-x-10 rtl:space-x-reverse"
    >
      {{- /* Home link: localhost when running locally, odoom.net in production (cross-domain from blog.odoom.net) */ -}}
      <a
        class="text-base font-normal home-link"
        href="{{ if strings.Contains .Site.BaseURL "localhost" }}{{ strings.TrimSuffix "/" .Site.BaseURL }}/{{ else }}https://odoom.net/{{ end }}"
        id="homeLink"
        ><span class="home-icon">⌂</span> <span class="home-text">Home</span></a
      >
    </nav><!---->
    {{- with site.Menus.main -}}
    <nav
      class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"
    >
      {{- range . -}}
      <a
        class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal"
        href="{{- .URL -}}"
        >{{- .Name -}}</a
      >
      {{- end -}}
    </nav>
    {{- end -}}<!---->

    {{- with $.Scratch.Get "social_list" -}}
    <nav
      class="mt-12 flex justify-center space-x-10 lg:mt-0 lg:items-center ltr:lg:ml-14 rtl:space-x-reverse rtl:lg:mr-14 dark:invert"
    >
      {{- range . -}}<!---->
      <a
        class="h-7 w-7 text-[0px] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./{{- . -}}.svg)"
        href="{{- if eq . `rss` -}}{{- `index.xml` | absURL -}}{{- else if eq . `mastodon` -}}{{- index site.Params . -}}{{- else -}}{{- if eq . `threads` -}}https://threads.net/{{- else if eq . `bluesky` -}}https://bsky.app/profile/{{- else -}}https://{{- . -}}.com/{{- end -}}{{- if eq . `linkedin` -}}in/{{- end -}}{{- index site.Params . -}}{{- end -}}"
        target="_blank"
        rel="{{- if eq . `rss` -}}alternate{{- else -}}me{{- end -}}"
      >
        {{- . -}}
      </a>
      {{- end -}}<!---->
    </nav>
    {{- end -}}<!---->
  </div>
</header>
